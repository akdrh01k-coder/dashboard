# ìˆ˜ì •ëœ ì „ì²´ ì½”ë“œ (ë¶™ì—¬ë„£ì–´ ì‹¤í–‰ ê°€ëŠ¥)
import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from streamlit_option_menu import option_menu
import streamlit.components.v1 as components
from urllib import parse as _url
from datetime import datetime, timedelta   # <-- timedelta ì¶”ê°€
import random
import string

# ========== ê¸°ë³¸ ì„¤ì • ==========
st.set_page_config(
    page_title="Eco Friendship ê´€ì œ ëŒ€ì‹œë³´ë“œ",
    page_icon="ğŸš¢",
    layout="wide",
    initial_sidebar_state="expanded"
)


# ========== ì „ì—­ ìŠ¤íƒ€ì¼ ==========
st.markdown("""
<style>
/* ê¸°ë³¸ ìš”ì†Œ ìˆ¨ê¹€ */
#MainMenu, header, footer {visibility: hidden;}

/* ìƒë‹¨ ê³ ì • ë°”ì™€ ì¶©ëŒ ì•ˆ ë‚˜ê²Œ ì—¬ë°± í™•ë³´ */
.main .block-container { padding-top: 96px !important; }

/* ì‚¬ì´ë“œë°” ë°ì€ í†¤ */
section[data-testid="stSidebar"] {
    background: #F1F1F9 !important;
    border-right: 1px solid #F1F1F9;
}

/* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ - ì „ì—­ì— ì˜í–¥ ì•ˆ ì£¼ë„ë¡ í´ë˜ìŠ¤ ê¸°ë°˜ */
.dash-card {
    background: #F6F7FB;
    border: 1px solid #EBEDF5;
    border-radius: 14px;
    padding: 16px 18px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}
.dash-card h3 { margin: 0 0 8px 0; }
.badge {
    display:inline-block; padding: 2px 8px; border-radius: 999px;
    font-size: 12px; font-weight: 700; background:#E8F6ED; color:#1E854A;
    border:1px solid #CFECDC;
}

/* íˆì–´ë¡œ ì„¹ì…˜ */
.hero {
    background: linear-gradient(135deg,#F0F2F7 0%, #E6EBF7 100%);
    border:1px solid #dfe5f2; border-radius:16px; padding:18px 22px;
}

/* KPI ìˆ«ì í¬ê²Œ */
.kpi-number { font-size: 36px; font-weight: 800; line-height: 1.1; }
.kpi-sub { color:#6b7280; font-size: 12px; }

/* ----- ì‚¬ì´ë“œë°” ë³´ì¡° ìŠ¤íƒ€ì¼ (ì¶”ê°€) ----- */
.sb-header { margin: 4px 2px 10px 2px; }
.sb-brand { display:flex; align-items:center; gap:8px; }
.sb-brand .logo { font-size:25px; }
.sb-brand .name { font-size:24px; font-weight:800; letter-spacing:.2px; }
.sb-subtitle { margin-top:2px; font-size:15px; opacity:.9; }
.sb-hr { border:0; border-top:1px solid #202635; margin:12px 0; }
.sb-section-title { font-size:20px; font-weight:700; letter-spacing:.2px; margin:2px 0 6px; opacity:.9; }
.sb-team { font-size:13px; line-height:1.5; }

 /* ===== ì„¹ì…˜(í° ë¸”ë¡) & í´ë¦­ ê°€ëŠ¥í•œ ì¹´ë“œ ===== */
.section{
  background:#FFFFFF; border:1px solid #E6ECF5; border-radius:16px;
  padding:16px 18px; box-shadow:0 10px 24px rgba(16,24,40,.06); margin-bottom:16px;
}
.section.soft{ background:#F7F9FC; }


/* ===== ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ (ì •ì‚¬ê°í˜•) ===== */
.nav-card { position: relative; }                  /* í´ë¦­ ì˜¤ë²„ë ˆì´ë¥¼ ìœ„í•œ ê¸°ì¤€ */
.nav-card-surface{
  background:#FFFFFF;
  border:1px solid #E4E9F4;
  border-radius:16px;
  padding:16px 18px;
  height:168px;                                    /* ì •ì‚¬ê°í˜• ëŠë‚Œ */
  box-shadow:0 12px 28px rgba(16,24,40,.06);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.nav-card-surface:hover{
  border-color:#BBD3FF; background:#F7FAFF; transform: translateY(-2px);
}
.nav-card-title{
  font-weight:800; font-size:18px; margin:0 0 8px 0; display:flex; align-items:center; gap:8px;
}
.nav-card-desc{ color:#6b7280; font-size:13px; line-height:1.5; }

/* ì¹´ë“œ ì „ì²´ë¥¼ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” íˆ¬ëª… ë²„íŠ¼ ì˜¤ë²„ë ˆì´ */
.nav-card .stButton{ position:absolute; inset:0; margin:0; }
.nav-card .stButton > button{
  position:absolute; inset:0; opacity:0; width:100%; height:100%; cursor:pointer;
  border:none; background:transparent; padding:0;
}

/* ===== ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ ì˜¤ë²„ë ˆì´ (ì¹´ë“œ ì „ì²´ í´ë¦­) ===== */
.nav-card { position: relative; }
.nav-card-surface{
  /* ê¸°ì¡´ ì¹´ë“œ ëŠë‚Œ ìœ ì§€ (ì—°í•œ ë°°ê²½/ë³´ë”/ë¼ìš´ë“œ/ì„€ë„ìš°) */
  background:#FFFFFF;
  border:1px solid #E4E9F4;
  border-radius:16px;
  padding:16px 18px;
  height:170px;                        /* ì •ì‚¬ê°í˜• ëŠë‚Œ */
  box-shadow:0 12px 28px rgba(16,24,40,.06);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.nav-card-surface:hover{ border-color:#BBD3FF; background:#F7FAFF; transform: translateY(-2px); }

/* ì¹´ë“œ ì•ˆ íƒ€ì´í¬ëŠ” ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©(.kpi-number, .kpi-sub, .badge ë“±) */
.nav-card-title{ font-weight:800; font-size:18px; margin:0 0 8px 0; display:flex; gap:8px; align-items:center; }
.nav-list{ margin:6px 0 0; padding-left:16px; }
.nav-list li{ margin:4px 0; }

/* ì§„í–‰ë°”(ê¸°ì¡´ progress ëŠë‚Œ ë³µì œ) */
.nav-progress{ height:8px; background:#E6EEF9; border-radius:999px; overflow:hidden; }
.nav-progress > div{ height:100%; background:#3B82F6; }

/* ì „ì²´ í´ë¦­ ì˜¤ë²„ë ˆì´(íˆ¬ëª… ë§í¬) */
a.nav-overlay{ position:absolute; inset:0; display:block; text-decoration:none; }
            
</style>
""", unsafe_allow_html=True)


# ë¼ìš°íŒ… ëŒ€ìƒ í˜ì´ì§€ ëª©ë¡ (ì‹ ê·œ: "ì¹œí™˜ê²½ ì§€í‘œ", "ì „ë ¥ ëª¨ë‹ˆí„°ë§"ìœ¼ë¡œ ëª…ì¹­ í†µì¼)
PAGES = ["ë©”ì¸ í™”ë©´","ì „ë ¥ ëª¨ë‹ˆí„°ë§","ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§","ë©”ì¸ ì»¨íŠ¸ë¡¤","ì•ˆì „/ê²½ë³´","ì¹œí™˜ê²½ ì§€í‘œ","ë¡œê·¸ì¸"]
if "nav" not in st.session_state:
    st.session_state["nav"] = "ë©”ì¸ í™”ë©´"
def _get_nav_from_query():
    try:
        v = st.query_params.get("nav")               # 1.29+ (QueryParams ê°ì²´)
    except AttributeError:
        v = st.experimental_get_query_params().get("nav")  # êµ¬ë²„ì „

    if v is None:
        return None
    return v if isinstance(v, str) else v[0]

_nav = _get_nav_from_query()
if _nav in PAGES and _nav != st.session_state["nav"]:
    st.session_state["nav"] = _nav


# ========== ì‚¬ì´ë“œë°” ==========
with st.sidebar:
    # --- ë¸Œëœë“œ/íƒœê·¸ë¼ì¸ ---
    st.markdown("""
    <div class="sb-header">
      <div class="sb-brand">
        <span class="logo">ğŸ›¥ï¸</span>
        <span class="name">Eco-Friendship<br>Project</span>
      </div>
      <div class="sb-subtitle">ì°¨ì„¸ëŒ€ ìˆ˜ì†Œ ì„ ë°• ê´€ì œ ì‹œìŠ¤í…œ</div>
    </div>
    <hr class="sb-hr">
    <div class="sb-section-title">MENU</div>
    """, unsafe_allow_html=True)

    STYLES_SIDEBAR = {
        "container": {"padding": "8px 8px", "background-color": "transparent"},
        "icon": {"color": "#1F2937", "font-size": "18px"},
        "nav-link": {
            "font-size": "16px",
            "text-align": "left",
            "margin": "6px 0",
            "color": "#1F2937",
            "--hover-color": "#A4C2FF",   # hover ë°°ê²½
        },
        "nav-link-selected": {
            "background-color": "#B1C9FA",
            "color": "#424446",
            "font-weight": "700",
        },
    }

    # --- ê¸°ì¡´ option_menu ê·¸ëŒ€ë¡œ (hover/ì„ íƒ ìŠ¤íƒ€ì¼ ìœ ì§€) ---
    selected_menu = option_menu(
        menu_title=None,  # ì œëª©ì€ ìœ„ì—ì„œ ë”°ë¡œ ë Œë”
        options=PAGES,
        icons=["house", "speedometer2", "geo-alt", "controller", "exclamation-triangle", "globe-americas", "person-circle"],
        menu_icon="cast",
        default_index=PAGES.index(st.session_state["nav"]),
        styles=STYLES_SIDEBAR
    )

# ì„ íƒ ë³€ê²½ ì²˜ë¦¬ (ì‚¬ì´ë“œë°” ë°”ê¹¥ì—ì„œ)
if selected_menu != st.session_state["nav"]:
    st.session_state["nav"] = selected_menu
    try:
        st.query_params.update({"nav": selected_menu})      # ìµœì‹  API (ìˆëŠ” ê²½ìš°)
    except Exception:
        st.experimental_set_query_params(nav=selected_menu) # êµ¬ë²„ì „ í˜¸í™˜
    st.rerun()


# --- íŒ€ ì •ë³´ ---
TEAM_NAME = "Eco-Friendship"
TEAM_MEMBERS = [
    "ì •ë¯¼êµ (ë©”ì¸ / ì—ë„ˆì§€)",
    "ì „ì˜ì¤€ (ë¹„ì „ / ë¼ì´ë‹¤)",
    "ë°•ì¬ë¦¼ (ì œì–´ / í•­ë²•)"
]
MENTOR_NAME = "ì‹ ìŠ¹í›ˆ ë©˜í† ë‹˜"

st.markdown("""
<style>
.team-container {
    background-color: #f7f8fc;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', sans-serif;
}
.team-title {
    font-size: 22px; font-weight: 700; margin-bottom: 10px;
    color: #2c3e50 !important;  /* ì „ì—­ ìƒ‰ ë®ì–´ì“°ê¸° ë°©ì§€ */
}
.team-subtitle {
    font-size: 16px; font-weight: 600; margin-bottom: 10px;
    color: #34495e !important;
}
.team-member { font-size: 15px; padding: 2px 0; color: #2c3e50 !important; }
.mentor { margin-top: 15px; font-size: 14px; font-style: italic; color: #7f8c8d !important; }
</style>
""", unsafe_allow_html=True)

members_html = "".join(f'<div class="team-member">{m}</div>' for m in TEAM_MEMBERS)
st.markdown(
    f"""
    <div class="team-container">
        <div class="team-title">Project Team: {TEAM_NAME}</div>
        <div class="team-subtitle">TEAM MEMBERS</div>
        {members_html}
        <div class="mentor">ğŸ‘¨â€ğŸ« {MENTOR_NAME}</div>
    </div>
    """,
    unsafe_allow_html=True
)


LOGIN_HREF = f"?nav={_url.quote('ë¡œê·¸ì¸')}"
try:
    from streamlit_autorefresh import st_autorefresh
    st_autorefresh(interval=1000, key="clock_tick")
except Exception:
    pass  # íŒ¨í‚¤ì§€ ì—†ìœ¼ë©´ ì •ì  í‘œê¸°ë¡œë§Œ í‘œì‹œ


now_str = datetime.now().strftime("%H:%M:%S")



# ê³ ì • ìƒë‹¨ë°” (ì‹œê³„ì— id="clock" ì¶”ê°€)
st.markdown(f"""
<style>
  .app-topbar{{
    position: fixed; top:0; left:0; right:0; height:64px;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 22px; z-index:1000;
    color:#fff; border-bottom:1px solid rgba(255,255,255,.15);
    background:linear-gradient(90deg,#3b4a67 0%, #536a92 100%);
    box-shadow:0 8px 24px rgba(0,0,0,.18);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }}
  .app-topbar .brand{{ font-weight:800; letter-spacing:.2px; }}
  .app-topbar .right{{ display:flex; gap:14px; align-items:center; }}
  .app-pill{{ background:rgba(255,255,255,.18); padding:6px 10px; border-radius:999px; font-weight:700; }}
  .app-link{{ color:#fff; text-decoration:none; }}
  .app-link:hover{{ text-decoration:underline; }}
  /* ë³¸ë¬¸ì´ í—¤ë”ì— ê°€ë¦¬ì§€ ì•Šë„ë¡ ì—¬ë°± */
  .block-container{{ padding-top:80px; }}
            
</style>

<div class="app-topbar">
  <div class="brand">Eco-Friendship Dashboard</div>
  <div class="right">
    <div class="app-pill" id="clock">{now_str}</div>
    <a class="app-pill app-link" href="?nav=%EB%A1%9C%EA%B7%B8%EC%9D%B8" target="_self" rel="noopener">Login</a>
  </div>
</div>

<script>
  function upd(){{
    const el = document.getElementById('clock'); 
    if(!el) return;
    const n = new Date();
    const t = [n.getHours(), n.getMinutes(), n.getSeconds()].map(v=>String(v).padStart(2,'0')).join(':');
    el.textContent = t;
  }}
  setInterval(upd, 1000); upd();
</script>
""", unsafe_allow_html=True)

st.markdown("""
<style>
[data-testid="stHeader"] { z-index: 0 !important; background: transparent !important; }
.app-topbar { z-index: 99999 !important; }
 [data-testid="stSidebarCollapseControl"],
[data-testid="stSidebarCollapseButton"]{
    position:fixed; top:12px; left:12px;
    z-index:100000 !important;
    display:flex !important; opacity:1 !important; pointer-events:auto !important;
  }
</style>
""", unsafe_allow_html=True)


# ========== ë°ëª¨ ë°ì´í„° ==========
np.random.seed(7)
time_index = pd.date_range(pd.Timestamp.now().floor('min') - pd.Timedelta(minutes=38), periods=40, freq="1min")
fc   = 120 + np.random.randn(40).cumsum()*0.05  # ì—°ë£Œì „ì§€ kW
pv   =  35 + np.random.randn(40).cumsum()*0.03  # íƒœì–‘ê´‘ kW
batt =  80 + np.random.randn(40).cumsum()*0.04  # ë°°í„°ë¦¬ kW
mix_now = [fc[-1], pv[-1], batt[-1]]

soc_now = 85  # %
cii_grade = "A"
speed_kn = 15.2
heading = 95  # deg
weather = "ë§‘ìŒ"
wind = 5.2
wave = 0.8

# ----- ê³µí†µ í˜ì´ì§€ í—¤ë” -----
PAGE_TITLES = {
    "ë©”ì¸ í™”ë©´": "ğŸš¢ H2-Ocean Pioneer Â· ë©”ì¸ ê´€ì œ",
    "ì „ë ¥ ëª¨ë‹ˆí„°ë§": "âš¡ ì „ë ¥ ëª¨ë‹ˆí„°ë§",
    "ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§": "ğŸ—ºï¸ ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§",
    "ë©”ì¸ ì»¨íŠ¸ë¡¤": "ğŸ§­ ë©”ì¸ ì»¨íŠ¸ë¡¤",
    "ì•ˆì „/ê²½ë³´": "ğŸ›Ÿ ì•ˆì „ Â· ê²½ë³´",
    "ì¹œí™˜ê²½ ì§€í‘œ": "ğŸŒ± ì¹œí™˜ê²½ ì§€í‘œ",
    "ë¡œê·¸ì¸": "ğŸ” ë¡œê·¸ì¸",
}

st.markdown("""
<style>
.page-header{
  margin: 6px 0 16px 0; padding: 14px 16px;
  background: linear-gradient(90deg,#eef4ff,#ffffff);
  border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.page-title{font-size:22px; font-weight:800; color:#1f2b4d;}
.page-sub{font-size:13px; color:#64748b;}
</style>
""", unsafe_allow_html=True)

def page_header(nav: str, sub: str | None = None):
    title = PAGE_TITLES.get(nav, nav)
    right = f"<div class='page-sub'>{sub}</div>" if sub else ""
    st.markdown(f"""
    <div class="page-header">
      <div class="page-title">{title}</div>
      {right}
    </div>
    """, unsafe_allow_html=True)


# ========== ë©”ì¸ í™”ë©´ ==========
if st.session_state["nav"] == "ë©”ì¸ í™”ë©´":
    # íˆì–´ë¡œ
    st.markdown(f"""
    <div class="hero">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
            <div>
                <h2 style="margin:0 0 4px 0;">ğŸš¢ H2-Ocean Pioneer Â· ë©”ì¸ ê´€ì œ</h2>
                <div class="badge">ì‹¤ì‹œê°„</div>
            </div>
            <div style="display:flex; gap:24px; align-items:center;">
                <div><div class="kpi-sub">í•­í•´ ìƒíƒœ</div><div class="kpi-number">âœ… ì•ˆì „ í•­í•´</div></div>
                <div><div class="kpi-sub">í˜„ì¬ ì†ë„</div><div class="kpi-number">{speed_kn:.1f} kn</div></div>
                <div><div class="kpi-sub">ì¹¨ë¡œ</div><div class="kpi-number">{heading}Â°</div></div>
            </div>
        </div>
    </div>
    """, unsafe_allow_html=True)
    st.markdown("")


# 4 ê°œì˜ ë©”ì¸ ëŒ€ì‹œë³´ë“œ (ì¤‘ë³µ ê²€ì‚¬ ì œê±° â€” í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡)
if st.session_state["nav"] == "ë©”ì¸ í™”ë©´":
    # íˆì–´ë¡œ ì•„ë˜ì—: í´ë¦­ ë„¤ë¹„ ì¹´ë“œ 4ê°œ
    st.markdown('<div class="section soft">', unsafe_allow_html=True)
    c1, c2, c3, c4 = st.columns(4)

    def nav_square_card(title: str, desc_lines: list[str], target: str, key: str, emoji: str = ""):
        """ì •ì‚¬ê°í˜• ë„¤ë¹„ ì¹´ë“œ: ì¹´ë“œ ì „ì²´ í´ë¦­ â†’ target í˜ì´ì§€ ì´ë™"""
        href = f"?nav={_url.quote(target)}"
        html = f"""
        <div class="nav-card">
        <a class="nav-overlay" href="{href}" target="_self"></a>
        <div class="nav-card-surface">
            <div class="nav-card-title">{emoji} {title}</div>
            <div class="nav-card-desc">{'<br>'.join(desc_lines)}</div>
        </div>
        </div>
        """
        st.markdown(html, unsafe_allow_html=True)


    with c1:
        nav_square_card(
            title="ì„ ë°• ìš´í•­ ìƒíƒœ",
            desc_lines=[f"ì •ìƒ", f"ì†ë„: {speed_kn:.1f} knots", f"ë°©í–¥: {heading}Â° (ENE)"],
            target="ë©”ì¸ ì»¨íŠ¸ë¡¤",
            key="card_ctrl",
            emoji="ğŸ§­"
        )
        
    with c2:
        total_kw = float(fc[-1] + pv[-1] + batt[-1])
        nav_square_card(
            title="ì „ë ¥ ì‹œìŠ¤í…œ",
            desc_lines=[f"<span class='kpi-number'>{total_kw:.0f} kW</span>",
                        "<span class='kpi-sub'>ì´ ì¶œë ¥ëŸ‰</span>",
                        f"ë°°í„°ë¦¬ SOC {soc_now}%"],
            target="ì „ë ¥ ëª¨ë‹ˆí„°ë§",
            key="card_power",
            emoji="âš¡"
        )

    with c3:
        nav_square_card(
            title="ì¹œí™˜ê²½ ì§€í‘œ",
            desc_lines=[f"<span class='kpi-sub'>CII ë“±ê¸‰</span>",
                        f"<span class='kpi-number'>{cii_grade} ë“±ê¸‰</span>",
                        "íƒ„ì†Œ ì €ê° ëª©í‘œ 95%"],
            target="ì¹œí™˜ê²½ ì§€í‘œ",
            key="card_green",
            emoji="ğŸŒ±"
        )

    with c4:
        nav_square_card(
            title="ì•ˆì „ Â· ê²½ë³´",
            desc_lines=["í˜„ì¬ ìƒíƒœ: ì •ìƒ", "ìµœê·¼ ê²½ë³´: 0ê±´"],
            target="ì•ˆì „/ê²½ë³´",
            key="card_alarm",
            emoji="ğŸ›Ÿ"
        )
        
    st.markdown('</div>', unsafe_allow_html=True)

    # ì•„ë˜ ë³¸ë¬¸ ë¸”ë¡ë“¤ë„ ì„¹ì…˜ìœ¼ë¡œ ê°ì‹¸ì„œ êµ¬ë¶„ê° â†‘
    st.markdown('<div class="section">', unsafe_allow_html=True)
    g1, g2 = st.columns([3,2])
    with g1:
        st.markdown("#### âš¡ ì „ë ¥ íŒ¨ë„")
        view = st.radio(
            "í‘œì‹œ ë°©ì‹",
            ["ì „ë ¥ ì¶”ì´ (kW)", "ëˆ„ì  ì—ë„ˆì§€ (kWh)", "ìŠ¤ëƒ…ìƒ·: íŒŒì›Œ í”Œë¡œìš°"],
            horizontal=True,
            label_visibility="collapsed"
        )

        # ì¤€ë¹„: ë°ì´í„°í”„ë ˆì„ & ë¶€í˜¸ ìˆëŠ” ë°°í„°ë¦¬ ì „ë ¥(ë°ëª¨ìš©)
        df = pd.DataFrame({"time": time_index, "ì—°ë£Œì „ì§€": fc, "íƒœì–‘ê´‘": pv, "ë°°í„°ë¦¬ì›": batt})
        batt_signed = (df["ë°°í„°ë¦¬ì›"] - df["ë°°í„°ë¦¬ì›"].mean()) * 0.8  # ì‹¤ì œ ê°’ ë“¤ì–´ì˜¤ë©´ êµì²´
        df["ë°°í„°ë¦¬"] = batt_signed
        df["ì´ë°œì „"] = df["ì—°ë£Œì „ì§€"] + df["íƒœì–‘ê´‘"]
        df["ìˆœì „ë ¥"] = df["ì´ë°œì „"] + df["ë°°í„°ë¦¬"]  # (+ ê³µê¸‰, - ì¶©ì „ì†Œëª¨)

        if view == "ì „ë ¥ ì¶”ì´ (kW)":
            fig = go.Figure()
            fig.add_trace(go.Scatter(x=df["time"], y=df["ì—°ë£Œì „ì§€"], name="ì—°ë£Œì „ì§€",
                                    mode="lines", line=dict(width=2), fill=None))
            fig.add_trace(go.Scatter(x=df["time"], y=df["ì—°ë£Œì „ì§€"] + df["íƒœì–‘ê´‘"], name="íƒœì–‘ê´‘",
                                    mode="lines", line=dict(width=0), fill="tonexty",
                                    hoverinfo="skip", showlegend=False))
            fig.add_trace(go.Scatter(x=df["time"], y=df["ë°°í„°ë¦¬"], name="ë°°í„°ë¦¬(ì¶©/ë°©ì „)",
                                    mode="lines", line=dict(width=1.5), fill="tozeroy"))
            fig.add_trace(go.Scatter(x=df["time"], y=df["ìˆœì „ë ¥"], name="ìˆœì „ë ¥(ë²„ìŠ¤)",
                                    mode="lines", line=dict(width=3)))
            fig.update_layout(margin=dict(l=10,r=10,t=10,b=0), hovermode="x unified",
                            height=340, legend=dict(orientation="h", yanchor="bottom", y=1.02, x=0))
            fig.update_yaxes(zeroline=True, zerolinewidth=1)
            st.plotly_chart(fig, use_container_width=True)

        elif view == "ëˆ„ì  ì—ë„ˆì§€ (kWh)":
            dth = df["time"].diff().dt.total_seconds().fillna(0) / 3600.0
            e_fc   = (df["ì—°ë£Œì „ì§€"] * dth).cumsum()
            e_pv   = (df["íƒœì–‘ê´‘"] * dth).cumsum()
            e_batt = (df["ë°°í„°ë¦¬"].clip(lower=0) * dth).cumsum()  # ë°©ì „ë§Œ ëˆ„ì 
            fig_e = go.Figure()
            fig_e.add_trace(go.Scatter(x=df["time"], y=e_fc, name="ì—°ë£Œì „ì§€(kWh)", mode="lines", line=dict(width=2)))
            fig_e.add_trace(go.Scatter(x=df["time"], y=e_fc + e_pv, name="íƒœì–‘ê´‘(kWh)", mode="lines",
                                    line=dict(width=0), fill="tonexty", hoverinfo="skip", showlegend=False))
            fig_e.add_trace(go.Scatter(x=df["time"], y=e_fc + e_pv + e_batt, name="ë°°í„°ë¦¬ ë°©ì „(kWh)",
                                    mode="lines", line=dict(width=0), fill="tonexty", hoverinfo="skip", showlegend=False))
            fig_e.update_layout(margin=dict(l=10,r=10,t=10,b=0), height=340,
                                hovermode="x unified", legend=dict(orientation="h", yanchor="bottom", y=1.02, x=0))
            st.plotly_chart(fig_e, use_container_width=True)

        else:  # "ìŠ¤ëƒ…ìƒ·: íŒŒì›Œ í”Œë¡œìš°"
            fc_now, pv_now, batt_now = float(df["ì—°ë£Œì „ì§€"].iloc[-1]), float(df["íƒœì–‘ê´‘"].iloc[-1]), float(df["ë°°í„°ë¦¬"].iloc[-1])
            batt_dis = max(batt_now, 0)      # ë°©ì „(ì¶œë ¥)
            batt_chg = max(-batt_now, 0)     # ì¶©ì „(ì†Œë¹„)
            bus_in = fc_now + pv_now + batt_dis
            bus_out = max(bus_in - batt_chg, 0)
            to_prop = bus_out * 0.85
            to_aux  = bus_out * 0.15

            labels = ["ì—°ë£Œì „ì§€", "íƒœì–‘ê´‘", "ë°°í„°ë¦¬", "DC ë²„ìŠ¤", "ì¶”ì§„", "ë³´ì¡°ë¶€í•˜", "ë°°í„°ë¦¬ ì¶©ì „"]
            src = [0, 1, 2, 3, 3, 3]
            tgt = [3, 3, 3, 4, 5, 6]
            val = [fc_now, pv_now, batt_dis, to_prop, to_aux, batt_chg]

            fig_s = go.Figure(data=[go.Sankey(
                node=dict(label=labels, pad=20, thickness=16),
                link=dict(source=src, target=tgt, value=val)
            )])
            fig_s.update_layout(margin=dict(l=10,r=10,t=10,b=10), height=340)
            st.plotly_chart(fig_s, use_container_width=True)

        # ëª¨ë“  ë·°ì—ì„œ ë³´ì´ëŠ” ìš”ì•½
        net_now = float(df["ìˆœì „ë ¥"].iloc[-1])
        batt_state = "ë°©ì „" if float(df["ë°°í„°ë¦¬"].iloc[-1]) >= 0 else "ì¶©ì „"
        st.caption(f"í˜„ì¬ ìˆœì „ë ¥: **{net_now:.1f} kW** Â· ë°°í„°ë¦¬ ìƒíƒœ: **{batt_state}**")
        
    with g2:        
        c21, c22 = st.columns(2)
        with c21:
            st.markdown("#### ğŸ”‹ SOC")
            fig_soc = go.Figure(go.Indicator(
                mode="gauge+number",
                value=soc_now,
                number={'suffix': "%"},
                gauge={'axis': {'range': [0, 100]},
                    'bar': {'thickness': 0.8},
                    'steps': [
                        {'range': [0, 20], 'color': "#fde2e1"},
                        {'range': [20, 60], 'color': "#fff3cd"},
                        {'range': [60, 100], 'color': "#e2f5e7"}],
                    'threshold': {'line': {'width': 3}, 'thickness': 0.9, 'value': soc_now}}
            ))
            fig_soc.update_layout(height=160, margin=dict(t=10,b=10,l=10,r=10))
            st.plotly_chart(fig_soc, use_container_width=True)

        with c22:
            st.markdown("#### âš¡ ì—ë„ˆì§€ ë¯¹ìŠ¤")
            fig_mix = go.Figure(go.Pie(values=mix_now, labels=["ì—°ë£Œì „ì§€","íƒœì–‘ê´‘","ë°°í„°ë¦¬"], hole=0.62))
            fig_mix.update_layout(height=160, margin=dict(t=10,b=10,l=10,r=10),
                                legend=dict(orientation="h", y=-0.1))
            st.plotly_chart(fig_mix, use_container_width=True)

        st.markdown("#### ğŸ—ºï¸ í˜„ì¬ ìœ„ì¹˜")
        map_df = pd.DataFrame({"lat":[35.10, 35.11, 35.12], "lon":[129.04, 129.06, 129.08]})
        st.map(map_df)
    st.markdown('</div>', unsafe_allow_html=True)

    st.markdown('<div class="section">', unsafe_allow_html=True)
    st.markdown("#### ğŸš¨ ì•Œë¦¼ Â· ì´ë²¤íŠ¸ ë¡œê·¸")
    alerts = pd.DataFrame([
    {"ì‹œê°„":"15:03:40","ìœ í˜•":"INFO","ë©”ì‹œì§€":"í•­í•´ ìƒíƒœ ì •ìƒ","ì‹¬ê°ë„":"ë‚®ìŒ"},
    {"ì‹œê°„":"15:02:11","ìœ í˜•":"WARN","ë©”ì‹œì§€":"ì¢Œí˜„ í’ì† ì¼ì‹œ ìƒìŠ¹(>8 m/s)","ì‹¬ê°ë„":"ì¤‘ê°„"},
    {"ì‹œê°„":"14:58:07","ìœ í˜•":"INFO","ë©”ì‹œì§€":"ë°°í„°ë¦¬ ì¶©ì „ ì‹œì‘(SOC<86%)","ì‹¬ê°ë„":"ë‚®ìŒ"},
    ])
    st.dataframe(alerts, hide_index=True, use_container_width=True)
    st.markdown('</div>', unsafe_allow_html=True)

# ========== ë‹¤ë¥¸ í˜ì´ì§€ ==========
elif st.session_state["nav"] == "ì „ë ¥ ëª¨ë‹ˆí„°ë§":
    page_header("ì „ë ¥ ëª¨ë‹ˆí„°ë§", sub=f"ì´ ì¶œë ¥ {float(fc[-1] + pv[-1] + batt[-1]):.0f} kW Â· ë°°í„°ë¦¬ SOC {soc_now}%")
    st.metric("ì´ ì¶œë ¥(kW)", f"{float(fc[-1] + pv[-1] + batt[-1]):.0f}")
    st.write("ì „ë ¥ íŒ¨ë„/í”Œë¡¯ ì˜ì—­ (ì¶”ê°€ ì˜ˆì •)")

elif st.session_state["nav"] == "ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§":
    page_header("ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§", sub="ì‹¤ì‹œê°„ ìœ„ì¹˜ Â· ê²½ë¡œ ì¶”ì ")
    st.write("ì§€ë„/íŠ¸ë™ í‘œì‹œ ì˜ì—­ (ì¶”ê°€ ì˜ˆì •)")

elif st.session_state["nav"] == "ë©”ì¸ ì»¨íŠ¸ë¡¤":
    page_header("ë©”ì¸ ì»¨íŠ¸ë¡¤", sub="ìˆ˜ë™/ììœ¨ ì „í™˜ Â· ì¶”ì§„/ì¡°í–¥ ì œì–´")
    st.write("ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì˜ì—­ (ì¶”ê°€ ì˜ˆì •)")

elif st.session_state["nav"] == "ì•ˆì „/ê²½ë³´":
    page_header("ì•ˆì „/ê²½ë³´", sub="í˜„ì¬ ìƒíƒœ ì •ìƒ Â· ìµœê·¼ ê²½ë³´ 0ê±´")
    st.write("ì•ŒëŒ/ì´ë²¤íŠ¸ ë¡œê·¸ ì˜ì—­ (ì¶”ê°€ ì˜ˆì •)")

elif st.session_state["nav"] == "ì¹œí™˜ê²½ ì§€í‘œ":
    page_header("ì¹œí™˜ê²½ ì§€í‘œ", sub=f"CII {cii_grade} ë“±ê¸‰ Â· íƒ„ì†Œ ì €ê° ëª©í‘œ 95%")
    st.write("ì§€í‘œ/ì§€ìˆ˜ ì¹´ë“œ ì˜ì—­ (ì¶”ê°€ ì˜ˆì •)")

elif st.session_state["nav"] == "ë¡œê·¸ì¸":
    # ---------- ë¡œê·¸ì¸ ì´ˆê¸°í™” ----------
    if "users" not in st.session_state:
        st.session_state["users"] = {
            "admin": {"password": "1234", "email": "admin@example.com", "is_active": True}
        }

    if "pw_reset" not in st.session_state:
        st.session_state["pw_reset"] = {}

    st.session_state.setdefault("logged_in", False)
    st.session_state.setdefault("username", None)
    st.session_state.setdefault("view", "login")

    # ì‹¤ì‹œê°„ ê²€ì¦ í”Œë˜ê·¸ ê¸°ë³¸ê°’
    st.session_state.setdefault("forgot_mismatch", False)
    st.session_state.setdefault("admin_mismatch", False)

    ADMIN_KEY = "ADMIN-KEY-CHANGE-ME"

    # -----------------------------
    # ìœ í‹¸
    # -----------------------------
    def gen_code(n=6):
        return "".join(random.choices(string.digits, k=n))

    def send_reset_code(username: str):
        code = gen_code()
        st.session_state.pw_reset[username] = {
            "code": code,
            "expire_at": datetime.utcnow() + timedelta(minutes=10),
        }
        return code

    def verify_reset_code(username: str, code: str) -> bool:
        item = st.session_state.pw_reset.get(username)
        if not item:
            return False
        if datetime.utcnow() > item["expire_at"]:
            return False
        return item["code"] == code

    def user_exists(username: str) -> bool:
        return username in st.session_state.users

    def check_password(username: str, password: str) -> bool:
        user = st.session_state.users.get(username)
        return bool(user and user["is_active"] and user["password"] == password)

    def create_or_activate_user(username: str, password: str, email: str):
        st.session_state.users[username] = {
            "password": password,
            "email": email,
            "is_active": True,
        }

    def nav_to(view: str):
        st.session_state["view"] = view
        st.experimental_rerun()

    # -----------------------------
    # ì½œë°±: ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ ì‹¤ì‹œê°„ ì²´í¬
    # -----------------------------
    def check_match(scope: str):
        """scope: 'forgot' ë˜ëŠ” 'admin'"""
        if scope == "forgot":
            pw = st.session_state.get("pw_new", "")
            pw2 = st.session_state.get("pw_new2", "")
            st.session_state["forgot_mismatch"] = bool(pw and pw2 and pw != pw2)
        elif scope == "admin":
            pw = st.session_state.get("ad_pw", "")
            pw2 = st.session_state.get("ad_pw2", "")
            st.session_state["admin_mismatch"] = bool(pw and pw2 and pw != pw2)

    # -----------------------------
    # ë¡œê·¸ì¸ í™”ë©´
    # -----------------------------
    def show_login_page():
        st.title("ğŸ” ë¡œê·¸ì¸")

        with st.form("login_form"):
            username = st.text_input("ì‚¬ìš©ì ì´ë¦„", placeholder="admin")
            password = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password", placeholder="â€¢â€¢â€¢â€¢")

            c1, c2, c3 = st.columns([1, 1, 1])
            with c2:
                submitted = st.form_submit_button("ë¡œê·¸ì¸", use_container_width=True)

            if submitted:
                if check_password(username, password):
                    st.session_state["logged_in"] = True
                    st.session_state["username"] = username
                    st.success("ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.")
                    st.experimental_rerun()
                else:
                    st.error("ì‚¬ìš©ì ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")

        lcol, rcol = st.columns(2)
        with lcol:
            if st.button("ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°", type="secondary", use_container_width=True):
                nav_to("forgot")
        with rcol:
            if st.button("ğŸ›¡ï¸ ê´€ë¦¬ì ë“±ë¡", type="secondary", use_container_width=True):
                nav_to("admin")

    # -----------------------------
    # ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í™”ë©´
    # -----------------------------
    def show_forgot_page():
        st.markdown("### ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°")
        if st.button("â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°", type="secondary"):
            nav_to("login")

        st.write("ì•„ì´ë””ë¥¼ í™•ì¸í•˜ì—¬ **ì¬ì„¤ì • ì½”ë“œ**ë¥¼ ë°œê¸‰ë°›ê³ , ì•„ë˜ì—ì„œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ì‹­ì‹œì˜¤.")

        # ì½”ë“œ ë°œê¸‰
        u = st.text_input("ì‚¬ìš©ì ì´ë¦„", placeholder="ë‚´ ì•„ì´ë””", key="pw_user")
        email_hint = st.text_input("ë“±ë¡ ì´ë©”ì¼(ì„ íƒ)", placeholder="name@example.com", key="pw_email")
        if st.button("ì¬ì„¤ì • ì½”ë“œ ë³´ë‚´ê¸°"):
            if not user_exists(u):
                st.error("í•´ë‹¹ ì‚¬ìš©ìê°€ ì—†ê±°ë‚˜ ë¹„í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤.")
            else:
                code = send_reset_code(u)
                st.info("ì¬ì„¤ì • ì½”ë“œê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°ëª¨ì´ë¯€ë¡œ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.)")
                with st.expander("ğŸ“© ë°ëª¨ ì½”ë“œ ë³´ê¸°"):
                    st.code(code, language="text")

        st.divider()

        # ì‹¤ì‹œê°„ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        u2 = st.text_input("ì‚¬ìš©ì ì´ë¦„(ë‹¤ì‹œ ì…ë ¥)", placeholder="ë‚´ ì•„ì´ë””", key="pw_user2")
        code_in = st.text_input("ì¬ì„¤ì • ì½”ë“œ", placeholder="6ìë¦¬ ìˆ«ì", key="pw_code")
        new_pw = st.text_input("ìƒˆ ë¹„ë°€ë²ˆí˜¸", type="password", key="pw_new")
        new_pw2 = st.text_input("ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸", type="password", key="pw_new2")

        if new_pw and new_pw2:
            if new_pw != new_pw2:
                st.markdown("<span style='color:red;'>ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>", unsafe_allow_html=True)
            else:
                st.markdown("<span style='color:green;'>ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.</span>", unsafe_allow_html=True)

        if st.button("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •"):
            if not user_exists(u2):
                st.error("í•´ë‹¹ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            elif new_pw != new_pw2:
                st.error("ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            elif not verify_reset_code(u2, code_in.strip()):
                st.error("ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•˜ì‹­ì‹œì˜¤.")
            else:
                st.session_state.users[u2]["password"] = new_pw
                st.session_state.pw_reset.pop(u2, None)
                st.success("ë¹„ë°€ë²ˆí˜¸ê°€ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ë¡œê·¸ì¸í•˜ì‹­ì‹œì˜¤.")

    # -----------------------------
    # ê´€ë¦¬ì ë“±ë¡ í™”ë©´
    # -----------------------------
    def show_admin_page():
        st.markdown("### ğŸ›¡ï¸ ê´€ë¦¬ì ë“±ë¡(ì´ˆëŒ€ì½”ë“œ)")
        if st.button("â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°", type="secondary"):
            nav_to("login")

        st.caption("ì‹ ê·œ ê³„ì •ì€ **ê´€ë¦¬ì ì´ˆëŒ€ì½”ë“œ**ë¡œë§Œ ìƒì„±/í™œì„±í™”ë©ë‹ˆë‹¤.")

        invite = st.text_input("ê´€ë¦¬ì ì´ˆëŒ€ì½”ë“œ", placeholder="ADMIN-KEY-â€¦", key="ad_invite")
        new_user = st.text_input("ìƒˆ ì‚¬ìš©ì ì´ë¦„", placeholder="ì˜ë¬¸/ìˆ«ì ê¶Œì¥", key="ad_user")
        new_email = st.text_input("ì´ë©”ì¼(ì„ íƒ)", placeholder="name@example.com", key="ad_email")
        new_pw = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password", key="ad_pw")
        new_pw2 = st.text_input("ë¹„ë°€ë²ˆí˜¸ í™•ì¸", type="password", key="ad_pw2")

        if new_pw and new_pw2:
            if new_pw != new_pw2:
                st.markdown("<span style='color:red;'>ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>", unsafe_allow_html=True)
            else:
                st.markdown("<span style='color:green;'>ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.</span>", unsafe_allow_html=True)

        if st.button("ê³„ì • ë§Œë“¤ê¸°"):
            if invite != ADMIN_KEY:
                st.error("ì´ˆëŒ€ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            elif not new_user or not new_pw:
                st.error("ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.")
            elif new_pw != new_pw2:
                st.error("ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            else:
                create_or_activate_user(new_user, new_pw, new_email)
                st.success("ê³„ì •ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë°©ê¸ˆ ë§Œë“  ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹­ì‹œì˜¤.")

    # -----------------------------
    # ë¡œê·¸ì¸ ì´í›„ ë©”ì¸
    # -----------------------------
    def show_main_page():
        st.markdown(
            "<h1 style='text-align:center;'>ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤!</h1>",
            unsafe_allow_html=True,
        )
        st.markdown(
            f"<h3 style='text-align:center;'>{st.session_state['username']}ë‹˜, ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</h3>",
            unsafe_allow_html=True,
        )
        st.markdown("<br>", unsafe_allow_html=True)
        c1, c2, c3 = st.columns([1, 1, 1])
        with c2:
            if st.button("ğŸ”“ ë¡œê·¸ì•„ì›ƒ", use_container_width=True):
                st.session_state["logged_in"] = False
                st.session_state["username"] = None
                st.session_state["view"] = "login"
                st.experimental_rerun()

    # ---------- ì‹¤ì œ ë·° ì„ íƒ ----------
    view = st.session_state.get("view", "login")
    if st.session_state.get("logged_in", False):
        show_main_page()
    else:
        if view == "login":
            show_login_page()
        elif view == "forgot":
            show_forgot_page()
        elif view == "admin":
            show_admin_page()

# (ë)
